{% extends "base.html" %}

{% block lab %}Лабораторная работа 6{% endblock %}

{% block main %}
<style>
    .office-container {
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        border: 2px solid orange;
        border-radius: 10px;
        box-sizing: border-box;
        background-color: #fff8f0;
    }
    h1, h2 {
        text-align: center;
        color: #ff6600;
    }
    #office-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
    }
    #office-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #ffcc99;
        border-radius: 6px;
        background-color: #fff2e6;
    }
    #office-list li button {
        padding: 5px 10px;
        cursor: pointer;
        border: 1px solid orange;
        border-radius: 5px;
        background-color: #ffedcc;
        transition: background-color 0.2s;
    }
    #office-list li button:hover {
        background-color: #ffd699;
    }
    .total-price {
        text-align: center;
        font-weight: bold;
        margin-top: 15px;
        font-size: 18px;
        color: #ff6600;
    }
</style>

<div class="office-container">
    <h1>Список кабинетов</h1>
    <ul id="office-list"></ul>

    <h2>Общая стоимость вашей аренды:</h2>
    <p id="total-price" class="total-price">0</p>
</div>
{% endblock %}

{% block script %}
<script>
function sendRequest(method, params, callback) {        // Функция для отправки JSON-RPC запросов
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': method,
        'params': params,
        'id': Math.floor(Math.random() * 10000)
    };

    fetch(url, {            // Отправляем POST запрос на сервер
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(r => r.json())        // Преобразуем ответ в JSON
    .then(data => {
        if (data.error) {       // Обрабатываем ошибки от сервера
            let msg = '';
            switch(data.error.code){
                case 1: msg='Вы не авторизованы'; break;
                case 2: msg='Офис уже арендован'; break;
                case 3: msg='Офис не арендован'; break;
                case 4: msg='Нельзя снять чужую аренду'; break;
                default: msg = data.error.message;
            }
            alert(msg);     // Показываем сообщение об ошибке
        }
        callback && callback(data);
    });
}

function updateOfficeList() {       // Функция обновления списка офисов на странице
    sendRequest('info', null, (data) => {       // Запрашиваем информацию об офисах
        const ul = document.getElementById('office-list');
        ul.innerHTML = '';      // Очищаем текущий список
        data.result.forEach(office => {     // Для каждого офиса создаем элемент списка
            const li = document.createElement('li');
            li.textContent = `${office.number} (цена: ${office.price}): ` +     // Отображаем номер, цену и статус офиса
                (office.tenant ? `арендован ${office.tenant}` : 'свободен');

            const btn = document.createElement('button');
            if(!office.tenant){     // В зависимости от статуса офиса создаем соответствующую кнопку
                btn.textContent = 'зарезервировать';
                btn.onclick = () => { booking(office.number); };
            } else {
                btn.textContent = 'освободить';
                btn.onclick = () => { cancellation(office.number); };
            }
            li.appendChild(btn);
            ul.appendChild(li);
        });
    });
}

function updateTotal() {        // Функция обновления общей стоимости аренды
    sendRequest('total', null, (data) => {
        if(!data.error){
            document.getElementById('total-price').innerText = data.result;
        }
    });
}

function booking(number) {      // Функция бронирования офиса
    sendRequest('booking', number, () => { 
        updateOfficeList();     // Обновляем список офисов
        updateTotal(); });      // Обновляем общую стоимость
}

function cancellation(number) {     // Функция отмены аренды офиса
    sendRequest('cancellation', number, () => { 
        updateOfficeList();     // Обновляем список офисов
        updateTotal(); });      // Обновляем общую стоимость
}

document.addEventListener('DOMContentLoaded', () => {       // Инициализация при загрузке страницы
    updateOfficeList();     // Загружаем список офисов
    updateTotal();          // Загружаем общую стоимость
});
</script>
{% endblock %}
