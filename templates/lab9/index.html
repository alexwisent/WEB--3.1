{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <style>
        :root {
            --bg-color: #0a3d62;
            --container-bg: rgba(255, 255, 255, 0.1);
            --gold-color: #fad390;
            --red-color: #e55039;
            --dark-red: #eb2f06;
            --green-color: #78e08f;
            --border-radius: 20px;
        }

        body {
            background: linear-gradient(135deg, #0a3d62, #1e3799);
            color: white;
            font-family: 'Arial', sans-serif;
            text-align: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: var(--gold-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 2.5em; margin-bottom: 20px; }

        .counter-container { background-color: var(--container-bg); border-radius: var(--border-radius); padding: 20px; margin: 20px auto; width: 80%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--gold-color); }
        .counter { font-size: 1.2em; margin: 10px 0; }
        #remaining { font-weight: bold; color: var(--gold-color); font-size: 1.5em; }
        .total-boxes { color: var(--green-color); font-size: 1.1em; margin-top: 10px; }

        .gifts-container { background-color: var(--container-bg); border-radius: var(--border-radius); padding: 40px 20px; margin: 30px auto; width: 90%; min-height: 500px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 3px solid var(--gold-color); }

        .gift-box, .gift-opened { transition: all 0.3s ease; position: absolute; width: 80px; height: 80px; }
        .gift-box {
            cursor: pointer;
            background-color: gray;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }
        .gift-box:hover { transform: scale(1.15) rotate(5deg); filter: drop-shadow(0 0 10px var(--gold-color)); }
        .gift-opened { width: 80px; height: 80px; animation: appear 0.5s ease-out; }
        @keyframes appear { 0% { transform: scale(0); } 70% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .magic-button-container { margin: 30px 0; }
        #magic-btn { background: linear-gradient(to bottom, var(--red-color), var(--dark-red)); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 18px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; }
        #magic-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); background: linear-gradient(to bottom, var(--dark-red), #c23616); }

        .info-box { background-color: var(--container-bg); border-radius: var(--border-radius); padding: 20px; margin: 20px auto; width: 80%; max-width: 600px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--green-color); }
        .info-box p { margin: 10px 0; font-size: 1.1em; line-height: 1.5; }

        .snowflake { position: absolute; color: white; font-size: 1.5em; user-select: none; z-index: -1; }

        @media (max-width: 768px) {
            .gift-box, .gift-opened { width: 60px; height: 60px; font-size: 20px; }
            .gifts-container { padding: 20px 10px; min-height: 400px; }
            h1 { font-size: 2em; }
        }
    </style>

    <div class="main-container">
        <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏! üéÅ</h1>  <!-- –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
        
        <div class="counter-container">
            <div class="counter">–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –µ—â—ë: <span id="remaining">{{ remaining }}</span> –∏–∑ {{ max_opened }}</div>  <!-- –°—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–æ—Ä–æ–±–æ–∫ -->
            <div class="total-boxes">–í—Å–µ–≥–æ –∫–æ—Ä–æ–±–æ–∫ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏: {{ boxes_count }}</div>  <!-- –í—Å–µ–≥–æ –∫–æ—Ä–æ–±–æ–∫ -->
        </div>
        
        <div class="gifts-container" id="gift-container">  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏ -->
            {% for box in boxes %}  <!-- –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ -->
                {% if current_user.is_authenticated %}
                    {% set is_opened = box.opened_by is not none and box.opened_by == current_user.id %}  <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –∫–æ—Ä–æ–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
                {% else %}
                    {% set is_opened = session.get('guest_opened', []) and box.id in session.get('guest_opened', []) %}  <!-- –î–ª—è –≥–æ—Å—Ç—è –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é -->
                {% endif %}
                
                {% if is_opened %}
                    <img src="{{ url_for('static', filename=box.image) }}" class="gift-opened" style="left:{{ box.pos_x }}px; top:{{ box.pos_y }}px;" alt="–û—Ç–∫—Ä—ã—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫">  <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—É—é –∫–æ—Ä–æ–±–∫—É -->
                {% else %}
                    <div class="gift-box" data-box-id="{{ box.id }}" style="left:{{ box.pos_x }}px; top:{{ box.pos_y }}px;">üîí</div>  <!-- –ó–∞–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞ -->
                {% endif %}
            {% endfor %}
        </div>
        
        {% if login %}
        <div class="magic-button-container">
            <button id="magic-btn">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑! (–°–±—Ä–æ—Å–∏—Ç—å –º–æ–∏ –∫–æ—Ä–æ–±–∫–∏)</button>  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫ -->
        </div>
        {% endif %}
        
        <div class="info-box">  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
            <p>üéÅ –û—Ç–∫—Ä–æ–π—Ç–µ –¥–æ {{ max_opened }} –∫–æ—Ä–æ–±–æ–∫ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏!</p>
            <p>‚ú® –ö–∞–∂–¥–∞—è –∫–æ—Ä–æ–±–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
            <p>üéÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–±—Ä–æ—Å–∏—Ç—å —Å–≤–æ–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è</p>
            <p>‚ùÑÔ∏è –í—Å–µ–≥–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {{ boxes_count }} –ø–æ–¥–∞—Ä–∫–æ–≤!</p>
        </div>
    </div>

    <script>
        document.querySelectorAll('.gift-box').forEach(box => {  
            box.addEventListener('click', () => {
                let boxId = box.dataset.boxId;
                fetch('/lab9/open/', {  
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({box_id: boxId})
                })
                .then(res => res.json())
                .then(data => {
                    if (data.error) { alert(data.error); }  
                    else {
                        const giftImg = document.createElement('img');
                        giftImg.src = '/static/' + data.image;
                        giftImg.className = 'gift-opened';
                        giftImg.style.left = box.style.left;
                        giftImg.style.top = box.style.top;
                        giftImg.alt = '–û—Ç–∫—Ä—ã—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫';
                        box.replaceWith(giftImg);  <!-- –ó–∞–º–µ–Ω—è–µ–º div –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–¥–∞—Ä–∫–∞ -->

                        setTimeout(() => { alert(data.message); }, 300);  <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 0.3—Å -->
                        document.getElementById('remaining').textContent = data.remaining;  <!-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è -->
                        if (data.remaining <= 0) setTimeout(() => { alert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏!'); }, 500);  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Å–µ—Ö –∫–æ—Ä–æ–±–æ–∫ -->
                    }
                })
                .catch(err => { console.error(err); alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏'); });  
            });
        });

        {% if login %}
        document.getElementById('magic-btn').addEventListener('click', () => {  
            if (confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –≤–µ—Ä–Ω—ë—Ç –≤—Å–µ –≤–∞—à–∏ –∫–æ—Ä–æ–±–∫–∏! –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                fetch('/lab9/magic/', {method:'POST'})  
                .then(res => res.json())
                .then(data => { if(data.status=='ok') location.reload(); })  
                .catch(err => { console.error(err); alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'); });  
            }
        });
        {% endif %}

        function createSnowflakes() {  
            const container = document.querySelector('.main-container');
            for (let i = 0; i < 15; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.textContent = '‚ùÑ';  
                snowflake.style.left = Math.random() * 100 + 'vw';  
                snowflake.style.top = Math.random() * 100 + 'vh';  
                snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';  
                snowflake.style.opacity = Math.random() * 0.5 + 0.3;  
                container.appendChild(snowflake);  
            }
        }
        window.addEventListener('load', createSnowflakes);  
    </script>
{% endblock %}

